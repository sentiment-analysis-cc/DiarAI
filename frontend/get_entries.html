<html>

<head>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script> 
    <script src="js/amazon-cognito-auth.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1162.0.min.js"></script>
    <script src="js/amazon-cognito-identity.min.js"></script>  
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        
        // Check if user is already logged in before loading the other content
        window.onload = function() {
            
            var cognitoUser = getCurrentUser();
            //console.log(cognitoUser);
            if (cognitoUser == null) {
                window.location.href = "login.html";
            }
            
            var username = cognitoUser.username;
            
            //console.log(username);
            
            var postData = {
                "username": username,
                "type" : "all",
            };
            
            // spara brutalmente verso aws
            // TO-DO: fare con post
            let data = $.ajax({
                type: "GET",
                url: _config.lambda_entries_url,
                data: postData,
                success: function(data) {
                    // Generate table from json entries, stored in req, with the following structure:
                    // title of entry, date of entry, compound sentiment, id of entry
                    
                    var table = document.getElementById("table");
                    var row = table.insertRow(0);
                    var cell1 = row.insertCell(0);
                    var cell2 = row.insertCell(1);
                    var cell3 = row.insertCell(2);
                    var cell4 = row.insertCell(3);
                    cell1.innerHTML = "Title";
                    cell2.innerHTML = "Date";
                    cell3.innerHTML = "Sentiment";
                    cell4.innerHTML = "ID";
                    
                    for (var i = 0; i < data.length; i++) {
                        console.log(data[i]);
                        var row = table.insertRow(i+1);
                        row.id = data[i].id;
                        var cell1 = row.insertCell(0);
                        var cell2 = row.insertCell(1);
                        var cell3 = row.insertCell(2);
                        var cell4 = row.insertCell(3);
                        cell1.innerHTML = "<a href=\"#"+ i + "\">" + data[i].title + "</a>";
                        cell2.innerText = data[i].date;
                        cell3.innerText = data[i].sentiment.compound;
                        cell4.innerText = data[i].id;
                    }

                    $('tr').click((e) => {
                        var id = e.currentTarget.id;
                        console.log(id);
                        var postData = {
                            "username": username,
                            "type" : "single",
                            "id" : id,
                        };
                        
                        let data = $.ajax({
                            type: "GET",
                            url: _config.lambda_entries_url,
                            data: postData,
                            success: function(data) {
                                console.log(data);
                            },
                            error: function(data) {
                                console.log(data);
                                alert("Some error occurred :(\n" + data);
                            }
                        });
                    });
                    
                },
                error: function(data) {
                    //console.log(data);
                    alert("Some error occurred :(\n" + data);
                }
            });    
        }
    </script>
</head>

<body>
    
    <table id="table"></table>
    
</body>      

</html>